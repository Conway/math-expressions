function substitute_ast(e,t){if(typeof e=="number")return e;if(typeof e=="string")return e in t?t[e]:e;var n=e[0],r=e.slice(1),i=[n].concat(r.map(function(e,n){return substitute_ast(e,t)}));return i}function tree_match(e,t){var n={};if(typeof t=="string")return n[t]=e,n;if(typeof e=="number")return typeof t=="number"&&t===e?{}:null;if(typeof e=="string")return typeof t=="string"?(n[t]=e,n):null;var r=e[0],i=e.slice(1),s=t[0],o=t.slice(1);if(r===s){if(i.length>=o.length){var u={};return o.forEach(function(e){var t=tree_match(i[e],o[e]);t===null&&(u=null),u!=null&&(u=$.extend(u,t))}),u!=null&&(u=$.extend(u,{remainder:i.slice(o.length)})),u}return null}return null}function subtree_matches(e,t){if(typeof e=="number")return typeof t=="string";if(typeof e=="string")return typeof t=="string";var n=tree_match(e,t);if(n!=null)return!0;var r=e[0],i=e.slice(1),s=!1;return $.each(i,function(e){subtree_matches(i[e],t)&&(s=!0)}),s}function replace_subtree(e,t,n){if(typeof e=="number")return e;if(typeof e=="string")return typeof t=="string"&&t===e?n:e;var r=tree_match(e,t);if(r!=null)return substitute_ast(n,r).concat(r.remainder);var i=e[0],s=e.slice(1);return[i].concat(s.map(function(e,r){return replace_subtree(e,t,n)}))}function associate_ast(e,t){if(typeof e=="number")return e;if(typeof e=="string")return e;var n=e[0],r=e.slice(1);r=r.map(function(e,n){return associate_ast(e,t)});if(n==t){var i=[];for(var s=0;s<r.length;s++)typeof r[s]!="number"&&typeof r[s]!="string"&&r[s][0]===t?i=i.concat(r[s].slice(1)):i.push(r[s]);r=i}return[n].concat(r)}function remove_identity(e,t,n){if(typeof e=="number")return e;if(typeof e=="string")return e;var r=e[0],i=e.slice(1);i=i.map(function(e,r){return remove_identity(e,t,n)});if(r==t){i=i.filter(function(e){return e!=n}),i.length==0&&(i=[n]);if(i.length==1)return i[0]}return[r].concat(i)}function remove_zeroes(e){if(typeof e=="number")return e;if(typeof e=="string")return e;var t=e[0],n=e.slice(1);n=n.map(function(e,t){return remove_zeroes(e)});if(t==="*")for(var r=0;r<n.length;r++)if(n[r]===0)return 0;return[t].concat(n)}function collapse_unary_minus(e){if(typeof e=="number")return e;if(typeof e=="string")return e;var t=e[0],n=e.slice(1);return n=n.map(function(e,t){return collapse_unary_minus(e)}),t=="~"&&typeof n[0]=="number"?-n[0]:[t].concat(n)}function clean_ast(e){return e=associate_ast(e,"+"),e=associate_ast(e,"-"),e=associate_ast(e,"*"),e=remove_identity(e,"*",1),e=collapse_unary_minus(e),e=remove_zeroes(e),e=remove_identity(e,"+",0),e}function leaves(e){if(typeof e=="number")return[e];if(typeof e=="string")return[e];var t=e[0],n=e.slice(1);return n.map(function(e,t){return leaves(e)}).reduce(function(e,t){return e.concat(t)})}function variables_in_ast(e){var t=leaves(e);return t=t.filter(function(e,t){return typeof e=="string"&&e!="e"&&e!="pi"}),t=t.filter(function(e,n,r){return n==t.indexOf(e)}),t}function derivative_of_ast(e,t,n){var r="\\frac{d}{d"+t+"} ";if(typeof e=="number")return n.push("The derivative of a constant is zero, that is, \\("+r+astToLatex(e)+" = 0\\)."),0;if(variables_in_ast(e).indexOf(t)<0)return n.push("The derivative of a constant is zero, that is, \\("+r+astToLatex(e)+" = 0\\)."),0;if(typeof e=="string")return t===e?(n.push("We know the derivative of the identity function is one, that is, \\("+r+astToLatex(e)+" = 1\\)."),1):(n.push("As far as \\("+astToLatex(t)+"\\) is concerned, \\("+astToLatex(e)+"\\) is constant, so "+r+astToLatex(e)+" = 0\\)."),0);var i=e[0],s=e.slice(1);if(i==="+"||i==="-"||i==="~"){n.push("Using the sum rule, \\("+r+astToLatex(e)+" = "+s.map(function(e,t){return r+astToLatex(e)}).join(" + ")+"\\).");var o=[i].concat(s.map(function(e,r){return derivative_of_ast(e,t,n)}));return o=clean_ast(o),n.push("So using the sum rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(i==="*"){var u=[],a=[];for(var f=0;f<s.length;f++)typeof s[f]=="number"||variables_in_ast(s[f]).indexOf(t)<0?(any_numbers=!0,a.push(s[f])):u.push(s[f]);if(a.length>0){if(u.length==0){n.push("Since the derivative of a constant is zero, \\("+r+astToLatex(e)+" = 0.\\)");var o=0;return o}var l=["*"].concat(u);u.length==1&&(l=u[0]);if(l===t){n.push("By the constant multiple rule, \\("+r+astToLatex(e)+" = "+a.map(function(e,t){return astToLatex(e)}).join(" \\cdot ")+"\\).");var o=["*"].concat(a);return o=clean_ast(o),o}n.push("By the constant multiple rule, \\("+r+astToLatex(e)+" = "+a.map(function(e,t){return astToLatex(e)}).join(" \\cdot ")+" \\cdot "+r+"\\left("+astToLatex(l)+"\\right)\\).");var c=derivative_of_ast(l,t,n),o=["*"].concat(a.concat([c]));return o=clean_ast(o),n.push("And so \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}n.push("Using the product rule, \\("+r+astToLatex(e)+" = "+s.map(function(e,t){return s.map(function(n,i){return t==i?r+"\\left("+astToLatex(e)+"\\right)":astToLatex(n)}).join(" \\cdot ")}).join(" + ")+"\\).");var h=s.slice(),o=["+"].concat(s.map(function(e,r){return["*"].concat(h.map(function(e,i){if(r==i){var s=derivative_of_ast(e,t,n);return s===1?null:s}return e}).filter(function(e){return e!=null}))}));return o=clean_ast(o),n.push("So using the product rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(i==="/"){var p=s[0],d=s[1];if(variables_in_ast(d).indexOf(t)<0){n.push("By the constant multiple rule, \\("+r+astToLatex(e)+" = "+astToLatex(["/",1,d])+" \\cdot "+r+"\\left("+astToLatex(p)+"\\right)\\).");var v=derivative_of_ast(p,t,n),m=textToAst("(1/g)*d"),o=substitute_ast(m,{d:v,g:d});return o=clean_ast(o),n.push("So \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(variables_in_ast(p).indexOf(t)<0){p!==1&&n.push("By the constant multiple rule, \\("+r+astToLatex(e)+" = "+astToLatex(p)+" \\cdot "+r+"\\left("+astToLatex(["/",1,d])+"\\right)\\)."),n.push("Since \\(\\frac{d}{du} \\frac{1}{u}\\) is \\(\\frac{-1}{u^2}\\), the chain rule gives \\("+r+astToLatex(e)+" = "+astToLatex(p)+"\\cdot \\frac{-1}{ "+astToLatex(d)+"^2"+"} \\cdot "+r+astToLatex(d)+"\\).");var g=derivative_of_ast(d,t,n),m=textToAst("f * (-a/(g^2))"),o=substitute_ast(m,{f:p,a:g,g:d});return o=clean_ast(o),n.push("So since \\(\\frac{d}{du} \\frac{1}{u}\\) is \\(\\frac{-1}{u^2}\\), the chain rule gives \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}n.push("Using the quotient rule, \\("+r+astToLatex(e)+" = \\frac{"+r+"\\left("+astToLatex(p)+"\\right) \\cdot "+astToLatex(d)+" - "+astToLatex(p)+"\\cdot "+r+"\\left("+astToLatex(d)+"\\right)}{ \\left( "+astToLatex(d)+" \\right)^2} \\).");var g=derivative_of_ast(p,t,n),y=derivative_of_ast(d,t,n),b=g,w=y,m=textToAst("(a * g - f * b)/(g^2)"),o=substitute_ast(m,{a:g,b:y,f:p,g:d});return o=clean_ast(o),n.push("So using the quotient rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(i==="^"){var E=s[0],S=s[1];if(variables_in_ast(S).indexOf(t)<0){if(typeof E=="string"&&E==="x"){if(typeof S=="number"){var x=textToAst("n * (f^m)"),o=substitute_ast(x,{n:S,m:S-1,f:E});return o=clean_ast(o),n.push("By the power rule, \\("+r+astToLatex(e)+" = "+astToLatex(S)+" \\cdot \\left("+astToLatex(E)+"\\right)^{"+astToLatex(["-",S,1])+"}\\)."),o}var x=textToAst("n * (f^(n-1))"),o=substitute_ast(x,{n:S,f:E});return o=clean_ast(o),n.push("By the power rule, \\("+r+astToLatex(e)+" = "+astToLatex(S)+" \\cdot \\left("+astToLatex(E)+"\\right)^{"+astToLatex(["-",S,1])+"}\\)."),o}S!=1&&n.push("By the power rule and the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(S)+" \\cdot \\left("+astToLatex(E)+"\\right)^{"+astToLatex(["-",S,1])+"} \\cdot "+r+astToLatex(E)+"\\).");var g=derivative_of_ast(E,t,n);if(S===1)return g;if(typeof S=="number"){var x=textToAst("n * (f^m) * a"),o=substitute_ast(x,{n:S,m:S-1,f:E,a:g});return o=clean_ast(o),n.push("So by the power rule and the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}var x=textToAst("n * (f^(n-1)) * a"),o=substitute_ast(x,{n:S,f:E,a:g});return o=clean_ast(o),n.push("So by the power rule and the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(E==="e"){if(typeof S=="string"&&S===t){var x=textToAst("e^(f)"),o=substitute_ast(x,{f:S});return o=clean_ast(o),n.push("The derivative of \\(e^"+astToLatex(t)+"\\) is itself, that is, \\("+r+astToLatex(e)+" = "+astToLatex(e)+"\\)."),o}n.push("Using the rule for \\(e^x\\) and the chain rule, we know \\("+r+astToLatex(e)+" = "+astToLatex(e)+" \\cdot "+r+astToLatex(S)+"\\).");var x=textToAst("e^(f)*d"),c=derivative_of_ast(S,t,n),o=substitute_ast(x,{f:S,d:c});return o=clean_ast(o),n.push("So using the rule for \\(e^x\\) and the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(typeof E=="number"){if(typeof S=="string"&&S===t){var x=textToAst("a^(f) * log(a)"),o=substitute_ast(x,{a:E,f:S});return o=clean_ast(o),n.push("The derivative of \\(a^"+astToLatex(t)+"\\) is \\(a^{"+astToLatex(t)+"} \\, \\log a\\), that is, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}var T=textToAst("a^(f) * log(a)"),N=substitute_ast(T,{a:E,f:S});n.push("Using the rule for \\(a^x\\) and the chain rule, we know \\("+r+astToLatex(e)+" = "+astToLatex(N)+" \\cdot "+r+astToLatex(S)+"\\).");var x=textToAst("a^(b)*log(a)*d"),c=derivative_of_ast(S,t,n),o=substitute_ast(x,{a:E,b:S,d:c});return o=clean_ast(o),n.push("So using the rule for \\(a^x\\) and the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}var p=E,d=S;n.push("Recall the general rule for exponents, namely that \\(\\frac{d}{dx} u(x)^{v(x)} = u(x)^{v(x)} \\cdot \\left( v'(x) \\cdot \\log u(x) + \\frac{v(x) \\cdot u'(x)}{u(x)} \\right)\\).  In this case, \\(u(x) = "+astToLatex(p)+"\\) and \\(v(x) = "+astToLatex(d)+"\\).");var g=derivative_of_ast(p,t,n),y=derivative_of_ast(d,t,n),x=textToAst("(f^g)*(b * log(f) + (g * a)/f)"),o=substitute_ast(x,{a:g,b:y,f:p,g:d});return o=clean_ast(o),n.push("So by the general rule for exponents, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(i==="apply"){var C=s[1];n.push("By the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(substitute_ast(["apply",s[0]+"'","x"],{x:C}))+" \\cdot "+r+astToLatex(C)+"\\).");var o=["*",substitute_ast(["apply",s[0]+"'","x"],{x:C}),derivative_of_ast(C,t,n)];return o=clean_ast(o),n.push("So by the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(i in derivatives){var C=s[0];if(typeof C=="number"){var o=0;return n.push("The derivative of a constant is zero so \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(typeof C=="string"&&C==t){var o=["*",substitute_ast(derivatives[i],{x:C})];return o=clean_ast(o),n.push("It is the case that \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}if(typeof C=="string"&&C!=t){var o=0;return n.push("Since the derivative of a constant is zero, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}n.push("Recall \\(\\frac{d}{du}"+astToLatex([i,"u"])+" = "+astToLatex(derivative_of_ast([i,"u"],"u",[]))+"\\)."),n.push("By the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(substitute_ast(derivatives[i],{x:C}))+" \\cdot "+r+astToLatex(C)+"\\).");var o=["*",substitute_ast(derivatives[i],{x:C}),derivative_of_ast(C,t,n)];return o=clean_ast(o),n.push("So by the chain rule, \\("+r+astToLatex(e)+" = "+astToLatex(o)+"\\)."),o}return 0}function lowercaseFirstLetter(e){return e.charAt(0).toLowerCase()+e.slice(1)}function simplify_story(e){for(var t=e.length-1;t>=1;t--)e[t]==e[t-1]&&e.splice(t,1);for(var t=0;t<e.length;t++)for(var n=t+1;n<e.length;n++)e[t]==e[n]&&(e[n]="Again, "+lowercaseFirstLetter(e[n]));return e}function randomBindings(e){var t={};return e.forEach(function(e){t[e]=Math.random()*20-10}),t}function randomComplexBindings(e){var t={};return e.forEach(function(e){t[e]=new ComplexNumber(Math.random()*20-10,Math.random()*20-10)}),t}function randomComplexBindingsBall(e,t,n){var r={};return e.forEach(function(e){r[e]=new ComplexNumber(t+Math.random()-.5,n+Math.random()-.5)}),r}function randomIntegerBindings(e){var t={};return e.forEach(function(e){t[e]=new ComplexNumber(Math.floor(Math.random()*30),0)}),t}function StraightLineProgram(e){this.syntax_tree=clean_ast(e)}var ComplexNumber=require("./complex-number").ComplexNumber,parser=require("./parser"),textToAst=parser.text.to.ast,latexToAst=parser.latex.to.ast,astToLatex=require("./parser").ast.to.latex,astToFunction=require("./parser").ast.to.function,astToComplexFunction=require("./parser").ast.to.complexFunction,derivatives={sin:textToAst("cos x"),cos:textToAst("-(sin x)"),tan:textToAst("(sec x)^2"),cot:textToAst("-((csc x)^2)"),sec:textToAst("(sec x)*(tan x)"),csc:textToAst("-(csc x)*(cot x)"),sqrt:textToAst("1/(2*sqrt(x))"),log:textToAst("1/x"),arcsin:textToAst("1/sqrt(1 - x^2)"),arccos:textToAst("-1/sqrt(1 - x^2)"),arctan:textToAst("1/(1 + x^2)"),arccsc:textToAst("-1/(sqrt(-1/x^2 + 1)*x^2)"),arcsec:textToAst("1/(sqrt(-1/x^2 + 1)*x^2)"),arccot:textToAst("-1/(1 + x^2)"),abs:textToAst("abs(x)/x")};StraightLineProgram.prototype={f:function(e){return astToFunction(this.syntax_tree)(e)},evaluate:function(e){return astToFunction(this.syntax_tree)(e)},complex_evaluate:function(e){return astToComplexFunction(this.syntax_tree)(e)},substitute:function(e){var t=new Object,n="abcdefghijklmnopqrstuvwxyz";for(var r=0;r<n.length;r++){var i=n.charAt(r);i in e&&(t[i]=e[i].syntax_tree)}return new StraightLineProgram(substitute_ast(this.syntax_tree,t))},tex:function(){return astToLatex(this.syntax_tree)},toString:function(){return astToText(this.syntax_tree)},integrate:function(e,t,n){var r=100,i=0,s=new Object;for(var o=0;o<r;o++){var u=t+(n-t)*(o+.5)/r;s[e]=u,i+=this.evaluate(s)}return i*(n-t)/r},equalsForBinding:function(e,t){var n=.01,r=this.evaluate(t),i=e.evaluate(t);return Math.abs(r/i-1)<n||r==i||isNaN(r)&&isNaN(i)},derivative:function(e){var t=[];return new StraightLineProgram(derivative_of_ast(this.syntax_tree,e,t))},derivative_story:function(e){var t=[];return derivative_of_ast(this.syntax_tree,e,t),t=simplify_story(t),t},variables:function(){return variables_in_ast(this.syntax_tree)},equals:function(e){function l(e){return(e.charCodeAt(0)-100)*.3}var t=0,n=.001,r=0,i=0,s=[this.variables(),e.variables()];s=s.reduce(function(e,t){return e.concat(t)}),s=s.reduce(function(e,t){return e.indexOf(t)<0&&e.push(t),e},[]);for(var o=0;o<s.length;o++)if(s[o]=="n"){for(var o=1;o<11;o++){var u=randomIntegerBindings(s),a=this.complex_evaluate(u),f=e.complex_evaluate(u);isFinite(a.real)&&isFinite(f.real)&&isFinite(a.imaginary)&&isFinite(f.imaginary)&&(t++,r+=a.subtract(f).modulus(),i+=f.modulus())}return t<1?!1:r<n*i+n*n?!0:!1}var c=[];for(var o=-10;o<11;o+=2)for(var h=-10;h<11;h+=2){var u={};s.forEach(function(e){u[e]=new ComplexNumber(o+l(e),h+l(e))});var a=this.complex_evaluate(u),f=e.complex_evaluate(u);if(isFinite(a.real)&&isFinite(f.real)&&isFinite(a.imaginary)&&isFinite(f.imaginary)){t++;var p=a.subtract(f).modulus();r+=p,i+=f.modulus(),p<1e-5&&c.length<3&&c.push([o,h])}}if(t<1)return!1;if(r<n*i+n*n)return!0;for(o=0;o<c.length;o++){var d=0,i=0;for(h=0;h<20;h++){var u=randomComplexBindingsBall(s,c[o][0],c[o][1]),a=this.complex_evaluate(u),f=e.complex_evaluate(u);i+=a.subtract(f).modulus()}if(i<1e-4)return!0}return!1}};var parse=function(e){return new StraightLineProgram(textToAst(e))},parse_tex=function(e){return new StraightLineProgram(latexToAst(e))};exports.fromText=parse,exports.parse=parse,exports.fromLaTeX=parse_tex,exports.fromLatex=parse_tex,exports.fromTeX=parse_tex,exports.fromTex=parse_tex,exports.parse_tex=parse_tex,define("math-expressions",function(){});